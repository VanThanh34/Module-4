<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Danh sách Blog</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="text-center mb-4 text-primary">Danh sách các Blog</h1>


    <div class="d-flex justify-content-between mb-3">
        <div class="input-group w-50">
            <input id="searchInput" type="text" class="form-control" placeholder="Tìm kiếm blog theo mô tả...">
            <button id="btnSearch" class="btn btn-outline-primary">Tìm</button>
        </div>
        <a th:href="@{/blogs/create}" class="btn btn-primary">+ Thêm mới</a>
    </div>


    <div class="table-responsive shadow-sm rounded w-95">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark text-center">
            <tr>
                <th scope="col">STT</th>
                <th scope="col">Ngày Blog</th>
                <th scope="col">Mô tả</th>
                <th scope="col">Danh Mục</th>
                <th scope="col">Nội dung</th>
                <th scope="col">Hành động</th>
            </tr>
            </thead>
            <tbody id="blogTableBody">

            </tbody>
        </table>
    </div>


    <div class="text-center mt-3">
        <button id="btnLoadMore" class="btn btn-outline-secondary">Tải thêm</button>
    </div>


    <p id="message" class="text-success fw-bold mt-3 text-center" th:text="${message}"></p>
</div>

<script>
    let currentPage = 0;
    let keyword = "";
    const pageSize = 5;


    function loadBlogs(reset = false) {
        fetch(`/api/blogs?page=${currentPage}&size=${pageSize}&keyword=${keyword}`)
            .then(resp => resp.json())
            .then(data => {
                if (reset) {
                    document.getElementById("blogTableBody").innerHTML = "";
                    currentPage = 0;
                }

                if (data.content.length === 0 && reset) {
                    document.getElementById("blogTableBody").innerHTML =
                        `<tr><td colspan="6" class="text-center text-danger fw-bold">Không tìm thấy blog nào</td></tr>`;
                    document.getElementById("btnLoadMore").style.display = "none";
                    return;
                }

                data.content.forEach((blog, index) => {
                    let row = `
                        <tr>
                            <td>${currentPage * pageSize + index + 1}</td>
                            <td>${blog.day}</td>
                            <td>${blog.description}</td>
                            <td>${blog.category ? blog.category.name : 'Không có'}</td>
                            <td>${blog.context}</td>
                            <td>
                                <div class="d-flex justify-content-center gap-2 flex-wrap">
                                    <a href="/blogs/detail/${blog.id}" class="btn btn-sm btn-info">Chi tiết</a>
                                    <a href="/blogs/update/${blog.id}" class="btn btn-sm btn-warning">Cập nhật</a>
                                    <a href="/blogs/delete/${blog.id}" class="btn btn-sm btn-danger"
                                       onclick="return confirm('Bạn có chắc muốn xoá blog này?')">Xoá</a>
                                </div>
                            </td>
                        </tr>`;
                    document.getElementById("blogTableBody").insertAdjacentHTML("beforeend", row);
                });


                if (data.last) {
                    document.getElementById("btnLoadMore").style.display = "none";
                } else {
                    document.getElementById("btnLoadMore").style.display = "inline-block";
                }
            });
    }


    document.getElementById("btnLoadMore").addEventListener("click", function () {
        currentPage++;
        loadBlogs();
    });


    document.getElementById("btnSearch").addEventListener("click", function () {
        keyword = document.getElementById("searchInput").value;
        currentPage = 0;
        loadBlogs(true); // reset = true => clear bảng
    });


    loadBlogs();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
