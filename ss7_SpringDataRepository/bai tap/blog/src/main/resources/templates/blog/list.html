<!DOCTYPE html>
<html lang="en" xmlns="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Danh sách Blog</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="text-center mb-4 text-primary" th:text="#{blog.list.title}"></h1>


    <div class="d-flex justify-content-between mb-3">
        <div class="input-group w-50">
            <input id="searchInput" type="text" class="form-control" th:placeholder="#{blog.list.search.placeholder}">
            <button id="btnSearch" class="btn btn-outline-primary" th:text="#{blog.list.search}"></button>
        </div>
        <a href="/blogs/create" class="btn btn-primary" th:text="#{blog.list.create}"></a>
    </div>


    <div class="table-responsive shadow-sm rounded">
        <table class="table table-striped table-bordered align-middle" id="tab-blog">
            <thead class="table-dark text-center">
            <tr>
                <th th:text="#{blog.list.number}"></th>
                <th th:text="#{blog.list.date}"></th>
                <th th:text="#{blog.list.description}"></th>
                <th th:text="#{blog.list.category}"></th>
                <th th:text="#{blog.list.context}"></th>
                <th th:text="#{blog.list.action}"></th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>


    <div class="text-center mt-3">
        <button id="btnLoadMore" class="btn btn-outline-secondary" th:text="#{blog.list.load}"></button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    let currentPage = 0;
    let keyword = "";
    const pageSize = 5;

    function loadBlogs(reset = false) {
        $.ajax({
            url: "/api/blogs",
            type: "GET",
            data: {
                page: currentPage,
                size: pageSize,
                keyword: keyword
            },
            success: function (data) {
                console.log(data);

                const tableBody = document.querySelector("#tab-blog tbody");

                if (reset) {
                    tableBody.innerHTML = "";
                    currentPage = 0;
                }

                if (data.content.length === 0 && reset) {
                    tableBody.innerHTML =
                        `<tr><td colspan="6" class="text-center text-danger fw-bold">Không tìm thấy blog nào</td></tr>`;
                    $("#btnLoadMore").hide();
                    return;
                }

                data.content.forEach((blog, index) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${currentPage * pageSize + index + 1}</td>
                        <td>${blog.day}</td>
                        <td>${blog.description}</td>
                        <td>${blog.category ? blog.category.name : 'Không có'}</td>
                        <td>${blog.context}</td>
                        <td>
                            <div class="d-flex justify-content-center gap-2 flex-wrap">
                                <a th:text="@{/blogs(leng=vi)}" class="btn btn-sm btn-info" ></a>
                                <a th:text="#{blog.list.action.update}" href="/blogs/update/${blog.id}" class="btn btn-sm btn-warning"></a>
                                <a th:text="#{blog.list.action.delete}" href="/blogs/delete/${blog.id}" class="btn btn-sm btn-danger"
                                   onclick="return confirm('Bạn có chắc muốn xoá blog này?')"></a>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                if (data.last) {
                    $("#btnLoadMore").hide();
                } else {
                    $("#btnLoadMore").show();
                }
            },
            error: function () {
                alert("Có lỗi xảy ra khi tải dữ liệu!");
            }
        });
    }

    // Nút tải thêm
    $("#btnLoadMore").click(function () {
        currentPage++;
        loadBlogs();
    });

    // Nút tìm kiếm
    $("#btnSearch").click(function () {
        keyword = $("#searchInput").value();
        currentPage = 0;
        loadBlogs(true);
    });

    // Tải lần đầu
    $(document).ready(function () {
        loadBlogs();
    });
</script>
</body>
</html>
